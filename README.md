# 智能投研平台需求分析（React + TS + shadcn / NestJS）

## 1. 一句话结论
这是一个“**多市场（A/H/US）+ 多资产（股票/基金/贵金属）+ 多智能体协作分析 + 自动化投研工作流**”的平台，核心壁垒在于：
1) 数据质量与时效；
2) 可解释的 AI 决策链路；
3) 策略执行与风控闭环。

---

## 2. 需求拆解（按业务域）

### 2.1 AI 决策仪表盘（最高优先级）
输出必须标准化：
- 一句话核心结论（看多/中性/看空 + 置信度）
- 精确买卖点位（入场、止损、止盈、仓位建议）
- 操作检查清单（是否满足交易纪律）

建议增加：
- 决策解释卡片（触发依据：技术面、资金面、情绪面）
- “反例风险”提示（哪些条件会让结论失效）

### 2.2 多维度分析引擎
- 技术面：K线形态、趋势、量价、关键均线、波动率
- 筹码分布：成本区、密集区、套牢区（A 股需特殊适配）
- 舆情情报：新闻、公告、社媒情绪、热词演化
- 实时行情：盘口、逐笔/分时（取决于行情供应商）

### 2.3 全球市场支持
- A 股：交易日历、涨跌停、北向资金、行业板块体系
- 港股：交易时段与美股重叠影响
- 美股：盘前盘后、财报事件驱动

### 2.4 复盘与组合管理
- 大盘复盘：指数、行业、资金流、核心事件
- 多组合：账户维度、策略维度、风险维度
- 收益分析：绝对收益、超额收益、回撤、夏普
- 压力测试：黑天鹅情景（利率、汇率、商品冲击）
- AI 诊断：组合偏离目标风险的原因定位

### 2.5 基金与股票监控
- 基金池管理：主题、风格、经理、回撤阈值
- 自动报告：盘前策略 + 盘后归因
- 自选股监控：基本面 + 技术面 + 风险事件雷达

### 2.6 AI 推荐与资讯能力
- 智能选股/选基：量化因子打分 + LLM 解释
- 新闻聚合：多源去重、可信度评分、情绪强度
- 商品情报：黄金/白银与美元、利率、地缘事件联动
- 市场情绪：多指标综合（波动率、成交、涨跌分布）

### 2.7 平台能力
- 邮件通知：日报、异动、风控触发推送
- 定时任务：盘前/盘中/盘后自动调度
- 多 LLM：OpenAI / Gemini / 兼容接口（统一网关）

---

## 3. 推荐技术架构

## 3.1 前端（React + TypeScript + shadcn/ui）
- 框架建议：Next.js（App Router）
- 状态管理：Zustand + React Query
- 图表：ECharts（金融图表能力完整）
- 权限：仅管理员创建用户（暂不做复杂权限系统）

核心页面：
1. AI 决策仪表盘
2. 市场总览（A/H/US）
3. 自选股与预警中心
4. 基金池与组合分析
5. 新闻与情绪中心
6. 策略任务中心（定时任务、邮件模板）

### 3.1.1 响应式与终端适配

| 终端 | 策略 |
|------|------|
| 桌面端（≥1280px） | 主力场景，完整功能，多面板布局 |
| 平板（768~1279px） | 简化布局，保留核心分析功能 |
| 移动端（<768px） | 仅查看模式：行情速览、预警通知、结论卡片 |

**MVP 建议**：优先桌面端，移动端仅做基础适配（查看行情 + 接收预警推送）

### 3.1.2 实时数据推送方案

| 方案 | 适用场景 | 选型建议 |
|------|---------|---------|
| WebSocket | 行情实时推送、盘口数据 | 推荐，双向通信，延迟低 |
| SSE（Server-Sent Events） | 预警通知、分析进度 | 轻量单向推送，备选 |
| 轮询 | 非实时数据（日报、组合快照） | 仅用于低频场景 |

**推荐架构**：
```
前端 ←── WebSocket ←── NestJS Gateway ←── Redis Pub/Sub ←── 行情服务
前端 ←── SSE ←── NestJS Controller ←── BullMQ 事件 ←── 分析任务
```

### 3.1.3 金融图表性能优化

ECharts 大数据量场景优化策略：

- **数据降采样**：分钟级 K 线超过 2000 根时，自动降采样显示（LTTB 算法）
- **虚拟滚动**：自选股列表、新闻列表使用 `react-virtuoso` 虚拟化渲染
- **懒加载**：图表组件按需加载（`React.lazy` + `Suspense`）
- **Web Worker**：技术指标计算（MA/MACD/RSI）放入 Worker 线程，避免阻塞 UI
- **Canvas 渲染**：ECharts 默认使用 Canvas 模式（非 SVG），大数据量下性能更优

### 3.1.4 离线与 PWA 能力

**MVP 阶段暂不实现 PWA**，但预留以下能力：
- Service Worker 注册入口（Next.js `next-pwa` 插件）
- 关键数据本地缓存策略（IndexedDB 存储最近查看的行情快照）
- 推送通知权限申请（配合预警系统）

## 3.2 后端（NestJS）
按领域拆分模块（建议 Monorepo）：
- market-data（行情接入、标准化、缓存）
- analytics（技术指标、因子计算、归因）
- ai-orchestrator（多智能体编排）
- portfolio（组合、持仓、绩效）
- alerting（规则引擎、通知中心）
- reporting（盘前/盘后报告）
- auth/user（鉴权、用户管理）

异步链路：
- BullMQ + Redis 做任务队列
- Cron + 事件驱动（Kafka/NATS 二选一，可后期引入）

## 3.3 数据库选型（推荐）
主库建议：**PostgreSQL + TimescaleDB 扩展 + Redis**
- PostgreSQL：业务主数据（用户、组合、策略、配置）
- TimescaleDB：时序行情、指标快照、回测结果
- Redis：实时缓存、会话、队列、热点榜单

可选增强：
- OpenSearch：新闻全文检索与舆情聚合
- S3/OSS：报告、图表、审计文件归档

为什么不先上 ClickHouse：
- 你当前阶段更需要"业务一致性 + 中高频时序查询 + 快速迭代"
- Timescale 足够支撑 MVP 到中期；后续极大规模再引入 ClickHouse 做 OLAP 专仓

## 3.4 行情数据源选型

### A 股候选供应商

| 供应商 | 数据粒度 | 费用（月） | 特点 |
|--------|---------|-----------|------|
| Tushare Pro | 分钟级 | ¥500~2,000（按积分） | 社区活跃，Python 友好，数据覆盖全 |
| AKShare | 分钟级 | 免费（爬虫） | 开源免费，但稳定性和合规性存疑 |
| 聚宽 JQData | 分钟级 | ¥600~3,000 | 量化平台配套，数据质量高 |
| 东方财富 Choice | Tick 级 | ¥3,000+ | 机构级数据，覆盖面最广 |
| 万得 Wind | Tick 级 | ¥5,000+ | 金融行业标准，成本最高 |

**MVP 建议**：Tushare Pro 或 聚宽 JQData（成本可控，分钟级足够）

### 美股候选供应商

| 供应商 | 数据粒度 | 费用（月） | 特点 |
|--------|---------|-----------|------|
| Alpha Vantage | 分钟级 | 免费~$50 | 免费额度有限，适合 MVP |
| Polygon.io | Tick 级 | $29~$199 | 实时性好，WebSocket 支持 |
| Yahoo Finance API | 日级/分钟级 | 免费（非官方） | 不稳定，不建议生产使用 |
| Finnhub | 分钟级 | 免费~$50 | 覆盖美股+加密货币 |

**MVP 建议**：Alpha Vantage（免费起步）+ Polygon.io（后续升级）

### 供应商抽象层设计

```
DataProvider (接口)
├── TushareProvider
├── JQDataProvider
├── AlphaVantageProvider
└── PolygonProvider

统一输出 Schema：
{
  symbol, market, timestamp,
  open, high, low, close, volume,
  source, latency_ms
}
```

## 3.5 数据存储策略

### TimescaleDB 分区与保留策略

| 数据类型 | 分区间隔 | 保留时长 | 压缩策略 |
|---------|---------|---------|---------|
| 分钟级行情 | 1 周 | 3 年 | 7 天后自动压缩 |
| 日级行情 | 1 月 | 永久 | 30 天后自动压缩 |
| 指标快照 | 1 周 | 1 年 | 7 天后自动压缩 |
| 回测结果 | 1 月 | 永久 | 不压缩 |

### 历史数据回填方案

1. **初始导入**：编写 ETL 脚本，从数据源批量拉取历史数据（建议至少 3 年）
2. **增量同步**：每日收盘后定时任务拉取当日数据
3. **数据校验**：导入后自动比对条数、缺失日期、异常值检测
4. **回填优先级**：A 股日线 → A 股分钟线 → 美股日线 → 美股分钟线

---

## 4. 多智能体协作方案（核心）

建议 6 个 Agent：
1. **行情 Agent**：读取实时与历史行情，生成结构化特征
2. **技术面 Agent**：趋势/形态/指标打分
3. **基本面 Agent**：财务、估值、公告事件
4. **舆情 Agent**：新闻情绪、热度与可信度
5. **风控 Agent**：仓位、回撤、止损规则校验
6. **投委会 Agent（总控）**：汇总冲突观点，输出最终建议

编排机制：
- 统一输入 Schema（标的、周期、风险偏好）
- 每个 Agent 输出 `结论 + 证据 + 置信度 + 失效条件`
- 总控做"加权投票 + 风险约束"，给出可执行指令

### 4.1 Agent 通信协议

**调用链路**：采用 DAG（有向无环图）编排，支持并行与依赖关系：

```
行情 Agent ──┬──→ 技术面 Agent ──┐
             ├──→ 基本面 Agent ──┤──→ 投委会 Agent → 最终输出
             └──→ 舆情 Agent   ──┤
                  风控 Agent ←───┘（最终否决权）
```

**Agent 间数据格式**（统一 JSON Schema）：

```json
{
  "agent_id": "technical_agent",
  "request_id": "uuid",
  "timestamp": "ISO8601",
  "input": { "symbol": "600519.SH", "period": "1d", "risk_preference": "moderate" },
  "output": {
    "conclusion": "看多",
    "confidence": 0.78,
    "evidence": ["MACD 金叉", "放量突破前高"],
    "invalidation": ["跌破 1800 支撑位"],
    "risk_level": "medium"
  },
  "latency_ms": 2300,
  "token_usage": { "input": 1200, "output": 800 }
}
```

**链路追踪**：每次分析请求生成唯一 `request_id`，所有 Agent 日志关联该 ID，便于调试和审计。

### 4.2 Prompt 管理方案

| 维度 | 方案 |
|------|------|
| 版本控制 | Prompt 模板存储在 `prompts/` 目录，随代码一起 Git 管理 |
| 模板引擎 | 使用 Handlebars/Mustache 语法，支持变量注入 |
| A/B 测试 | 通过配置表指定 Agent 使用的 Prompt 版本，按比例分流 |
| 评估指标 | 准确率、置信度校准、用户采纳率、Token 消耗 |

Prompt 目录结构：
```
prompts/
├── technical_agent/
│   ├── v1.0.md        # 基础版
│   ├── v1.1.md        # 优化版
│   └── config.json    # 当前激活版本、分流比例
├── sentiment_agent/
└── committee_agent/
```

### 4.3 LLM Token 成本估算

**单次完整分析（6 Agent 协作，单只标的）**：

| Agent | 输入 Token | 输出 Token | 单次成本（GPT-4o） |
|-------|-----------|-----------|-------------------|
| 行情 Agent | ~2,000 | ~500 | ~$0.006 |
| 技术面 Agent | ~3,000 | ~1,000 | ~$0.012 |
| 基本面 Agent | ~4,000 | ~1,500 | ~$0.018 |
| 舆情 Agent | ~5,000 | ~2,000 | ~$0.025 |
| 风控 Agent | ~1,500 | ~500 | ~$0.005 |
| 投委会 Agent | ~6,000 | ~2,000 | ~$0.028 |
| **合计** | **~21,500** | **~7,500** | **~$0.094** |

**月度成本估算**（假设每日分析 50 只标的）：
- 日成本：50 × $0.094 ≈ **$4.7/天**
- 月成本：**$141/月**（约 ¥1,000）
- 若使用更便宜的模型（如 GPT-4o-mini / Gemini Flash）可降至 **¥200~400/月**

### 4.4 LLM 降级与容错策略

```
主模型（GPT-4o / Gemini Pro）
  ↓ 超时或报错
备用模型（GPT-4o-mini / Gemini Flash）
  ↓ 仍然失败
缓存兜底（返回最近一次有效分析结果 + 标记"非实时"）
  ↓ 无缓存
规则引擎兜底（纯技术指标规则，不依赖 LLM）
```

- 每个 Agent 独立降级，不影响其他 Agent
- 降级事件记录到监控系统，触发运维告警
- 投委会 Agent 在汇总时标注哪些 Agent 使用了降级结果

---

## 5. MVP 建议（12 周）

### 阶段 1（第 1-4 周）
- 打通 A 股 + 美股基础行情
- 完成 AI 仪表盘 v1（结论/点位/清单）
- 自选股监控 + 邮件预警
- 完成管理员创建用户 + 用户登录（管理员开通账号）

### 阶段 2（第 5-8 周）
- 基金池管理 + 盘前/盘后报告自动化
- 多智能体 v1（技术面 + 舆情 + 风控）
- 组合绩效分析（收益、回撤、归因）

### 阶段 3（第 9-12 周）
- 港股接入、市场情绪与商品情报
- 多语言与多 LLM 网关
- 压力测试 + AI 诊断

---

## 6. 关键风险与对策
- **行情源合规与成本**：先做供应商抽象层，避免绑定单一厂商
- **AI 幻觉风险**：强制证据链 + 可追溯引用 + 风控 Agent 最终否决权
- **实时性能压力**：冷热分层（Redis 热数据 + Timescale 冷数据）
- **可解释性不足**：输出模板强制包含“依据/失效条件/风险等级”
- **账号安全风险**：MFA 预留、登录限流、审计日志、管理员操作二次确认

---

## 7. 需求确认结果（已根据你的回复落地）

### 7.1 你已确认的 10 条产品决策
1. 上线顺序：**A 股优先**。
2. 行情预算：你暂未确定，先按我建议的“**MVP 成本优先方案**”执行（见 7.2）。
3. 用户类型：**个人投资者**。
4. 交易模式：**仅做决策支持，不接实盘下单**。
5. 信号延迟：**分钟级**。
6. 报告频率：**日报**。
7. 风控红线：你暂未确定，先按我建议的“**默认风控参数**”执行（见 7.2）。
8. 部署方式：**Docker 部署到服务器，使用 docker compose build / up**。
9. 账号策略：**管理员创建用户 + 初始密码 + 首次登录强制改密**。
10. SSO：**暂不需要**。

### 7.2 未确定项的默认建议（可直接用于 MVP）
- 行情供应商预算（MVP）：建议先控制在 **¥2,000 ~ ¥8,000 / 月**（A 股分钟级 + 基础新闻/公告）。
- 默认风控红线（个人投资场景）：
  - 单票仓位上限：**20%**
  - 单日账户最大回撤预警：**2%**（触发减仓检查）
  - 组合最大回撤硬阈值：**12%**（触发风控模式，暂停新增仓位）
  - 止损线：单票从买入价回撤 **8%** 触发止损复核
  - 行业集中度上限：**30%**

### 7.3 对应实施动作（本周就能落）
- 在 `users` 表增加字段：`is_admin`, `must_change_password`, `status`。
- 登录流程加入“首次登录强制改密”中间态。
- 定时任务按“日报”生成盘后报告并邮件推送。
- 仅接入 A 股分钟级数据源，先跑通分析闭环。

---

## 8. 结论
你的需求是“高价值但复杂度高”的产品方向。建议以“**AI 决策仪表盘 + 自选监控 + 自动报告**”为 MVP 主线，先建立可解释、可执行、可复盘的闭环，再逐步扩展到多市场与多智能体深度协作。
